<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capacity Map</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Replace YOUR_API_KEY_HERE with your actual Google Maps API key -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7Zn_MdkjojRyTp4QTb0SnZlXzTo_kmA8&callback=initMap"
    loading="async">
    </script>


  <script>
    // List of GeoJSON files to load
    const geoJsonFiles = [
      'andira_marau.json',
      'arawete_igarape_ipixuna.json',
      'bau.json',
      'jaragua.json',
      'maro.json',
      'munduruku_taquara.json',
      'parque_do_xingu.json',
      'pimentel_barbosa.json',
      'uru_eu_wau_wau.json',
      'vale_do_javari.json',
      'yanomami.json'
    ];

    async function loadGeoJsonFiles(map) {
      try {
        // Fetch all GeoJSON files in parallel
        const promises = geoJsonFiles.map(file =>
          fetch(`geojsons/${file}`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`Failed to load ${file}: ${response.statusText}`);
              }
              return response.json();
            })
            .catch(error => {
              console.error(`Error loading ${file}:`, error);
              return null;
            })
        );

        const geoJsonDataArray = await Promise.all(promises);

        // Add each valid GeoJSON to the map
        geoJsonDataArray.forEach((geoJson, index) => {
          if (geoJson) {
            map.data.addGeoJson(geoJson);
            console.log(`Loaded ${geoJsonFiles[index]}`);
          }
        });

        // Fit map bounds to show all loaded features
        const bounds = new google.maps.LatLngBounds();
        map.data.forEach(feature => {
          feature.getGeometry().forEachLatLng(latLng => {
            bounds.extend(latLng);
          });
        });
        map.fitBounds(bounds);

      } catch (error) {
        console.error('Error loading GeoJSON files:', error);
      }
    }

    function initMap() {
      // Initialize map centered on Brazil (will auto-adjust after loading data)
      const map = new google.maps.Map(document.getElementById('map'), {
        // mapId: "ebb9f622ef97bae1ad6cf97a",
        mapTypeId: 'hybrid',
        zoomControl: true,
        cameraControl: false,
        mapTypeControl: false,
        scaleControl: true,
        streetViewControl: false,
        rotateControl: false,
        fullscreenControl: false,
        zoom: 8,
        center: { lat: 0, lng: -58.0 }
      });

      // Load GeoJSON files from the /geojsons directory
      loadGeoJsonFiles(map);

      // Style the polygons
      map.data.setStyle({
        fillColor: '#AD6DEF',
        fillOpacity: 0.5,
        strokeColor: '#AD6DEF',
        strokeWeight: 2
      });

      // Create an InfoWindow for popup display
      const infoWindow = new google.maps.InfoWindow();

      // OPTION 1: Show popup/callout on click
      // Uncomment this block to use popup behavior

      // map.data.addListener('click', function (event) {
      //   const name = event.feature.getProperty('name');
      //   const id = event.feature.getProperty('id');

      //   // Get the click position
      //   const position = event.latLng;

      //   // Set content and position for the InfoWindow
      //   infoWindow.setContent(`
      //     <div style="padding: 10px;">
      //       <h3 style="margin: 0 0 5px 0;">${name}</h3>
      //       <p style="margin: 0;">Territory ID: ${id}</p>
      //     </div>
      //   `);
      //   infoWindow.setPosition(position);
      //   infoWindow.open(map);
      // });


      // OPTION 2: Navigate to anchor link (works with parent page if in iframe)
      // This is currently active

      // map.data.addListener('click', function (event) {
      //   const id = event.feature.getProperty('id');
      //   const name = event.feature.getProperty('name');

      //   // Create anchor link from the ID (e.g., #area-1, #area-2, etc.)
      //   const anchor = `#area-${id}`;

      //   // If this page is in an iframe, navigate the parent page
      //   if (window.parent !== window) {
      //     // In an iframe - update parent URL
      //     window.parent.location.hash = anchor;
      //   } else {
      //     // Not in iframe - navigate this page
      //     window.location.hash = anchor;
      //   }

      //   console.log(`Clicked ${name} - navigating to ${anchor}`);
      // });

      // Add hover effect
      map.data.addListener('mouseover', function (event) {
        map.data.overrideStyle(event.feature, {
          fillOpacity: 0.6,
          strokeWeight: 3
        });
      });

      map.data.addListener('mouseout', function (event) {
        map.data.revertStyle();
      });
    }
  </script>
</body>

</html>